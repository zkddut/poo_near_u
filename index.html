<html>
<head>
  <title>My map</title>
  <script src="http://code.jquery.com/jquery-latest.js"></script>
</head>
<style>
#map {
  width: 100%;
  height: 400px;
  background-color: grey;
}
</style>
<script defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA88INSm7Of_HmfnzSX4oox0NNI7QeCrKA&callback=updateMap">
</script>
<body>
  My Google map
  <div id="map"></div>
  <form>
    <label for="start_time">Start Time:</label><br>
    <input type="date" id="start_time" name="start_time" value="2020-02-24"><br>
    <label for="end_time">End Time:</label><br>
    <input type="date" id="end_time" name="end_time" value="2020-02-25"><br><br>
    <input type="submit" id="query_submit" value="Query">
  </form>
  <div id="search_output"></div> <br>
  <div id="count_output"></div> <br>
  <div id="crime_output"></div>

  <script>
    $(document).ready(function() {
      $("#query_submit").click(function(e) {
        e.preventDefault();
        var x = $("form").serializeArray(); 
        $("#search_output").html("");
        $.each(x, function(i, field) { 
          $("#search_output").append(field.name + ":" + field.value + " "); 
        }); 
        const start_time = $('#start_time').val();
        const end_time = $('#end_time').val();
        updateMap(start_time, end_time);
      }); 
    }); 

    const crimeToEmoji = {
      "Vandalism": "vandalism.png",
      "Larceny from Auto": "larceny_auto.png",
      "Larceny": "larceny.png",
    };

    function updateMap(start_time= "2020-02-24", end_time="2020-02-25") {
      var Hayward = {lat: 37.646993, lng: -122.114681};
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: Hayward
      });
      const crime_data = [];
      var geocoder = new google.maps.Geocoder();
      const haywardCrimeLastYear =
        "https://maps.hayward-ca.gov/arcgis/rest/services/OpenData/COH_CrimeData/FeatureServer/0/query?where=Date%20%3E%3D%20TIMESTAMP%20'" +
        start_time +
        "%2001%3A05%3A00'%20AND%20Date%20%3C%3D%20TIMESTAMP%20'" +
        end_time +
        "%2001%3A05%3A00'&outFields=*&outSR=4326&f=json";

      $.ajax({
        url: haywardCrimeLastYear,
        type: 'get',
        dataType: 'json',
        async: false,
        success: function(data) {
          const items = data.features;
          $('#crime_output').html("");
          $.each(items, function(i){
            if (items[i].geometry && items[i].attributes) {
              var d = new Date(items[i].attributes.Date);
              crime_data.push(
                {
                  "location": items[i].attributes.Address + " , Hayward, CA, USA",
                  "type": items[i].attributes.Crime_Type,
                  "geo": { "lat": items[i].geometry.y, "lng": items[i].geometry.x },
                  "time": d.toLocaleString()
                }
              ); 
              $('#crime_output').append(items[i].attributes.Address + ":" + items[i].attributes.Crime_Type + ":" + d.toLocaleString() + "<br>");  
            }
          });
        }
      });

      crime_data.forEach((crime_entry) => {
        var emoji = crimeToEmoji[crime_entry.type] || "vandalism.png";
        var marker = new google.maps.Marker({
          map: map,
          position: crime_entry.geo,
          animation: google.maps.Animation.DROP,
          icon: emoji,
          title: crime_entry.type + " " + crime_entry.time
        });
      })

      $("#count_output").html("crime count : " + crime_data.length);
    }
  </script>

</body>
</html>
